<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>CosyVerif</title>

    <!-- Bootstrap core CSS -->
    <link href="css/index.css" rel="stylesheet">
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/bootstrap-switch.css" rel="stylesheet">
    <link rel="stylesheet" href="css/font-awesome.css">

    <!-- Model Graph styles-->      
    <link rel="stylesheet" type="text/css" href="css/editor.css">
    <link rel="stylesheet" type="text/css" href="css/dev.css">
    <link rel="stylesheet" href="css/codemirror.css">


    <!-- We include all the js we need-->
    <script src="js/codemirror.js"></script>
    <script type="text/javascript" src="js/d3.js"></script>
    <script type="text/javascript" src="js/editor.js"></script>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/bootstrap-switch.js"></script>
    <script src="js/handlebars.js"></script>
    <script src="js/bootstrap-typeahead.js"></script>
    <!-- <script src="template/project.template" type="text/x-handlebars-template"></script> -->
    <script src="js/index.js"></script>

    <link rel="stylesheet" href="css/jquery-ui.css">
    <script src="js/jquery-ui.js"></script>

    <script src="js/jquery-fullscreen.js"></script>

    <script src="js/jquery.textareafullscreen.js"></script>
<link rel="stylesheet" href="css/textareafullscreen.css">

  </head>

  <body>
     <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <div style="display:inline-block;">
              <img src="img/cosyverif.png" alt="Log image" class="img-thumbnail" height="100" width="100">
            </div>
            <div style="display:inline-block;margin-top:8px;">
              <button type="button" class="glyphicon glyphicon-resize-full screen-close"  id="body-button-fullscreen" data-toggle="tooltip" title="Full screen" onclick="fullScreen()" style="display:inline-block;height:35px;width:35px;"></button>
              <button type="button" class="fa fa-search" data-toggle="tooltip" title="Search" onclick="showSearch(true)" style="display:inline-block;height:35px;width:35px;"></button>
            </div>
          </div>
          <div class="col-md-6">
            <div class="navbar-collapse collapse">
              <form class="navbar-form navbar-right" role="form">
                <div class="form-group">
                  <input id="usernamePlaceHolder" placeholder="Username" class="form-control" type="text">
                </div>
                <div class="form-group">
                  <input id="passwordPlaceHolder" placeholder="Password" class="form-control" type="password">
                </div>
                <a href="#" id="userLogin"><i id="usernameLogo" class="fa fa-user" style="display:none;"></i><h4 id="usernameLabel" style="display:none; color:white"></h4></a>
                <button type="button" id="btnLogin" class="btn btn-success" onclick="loginClick()" data-toggle="tooltip" title="Sign in"><i class="fa fa-sign-in"></i></button>
                <button type="button" id="btnSignUp" class="btn btn-success" onclick="newUser()"  data-toggle="tooltip" title="Create account"><i class="fa fa-plus-square"></i></button>
                <button type="button" id="btnLogoff" class="btn btn-success" onclick="logoutClick()" style="display:none"  data-toggle="tooltip" title="Sign out"><i class="fa fa-sign-out"></i></button>
              </form>
            </div><!--/.navbar-collapse -->
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="row">
        <div class="col-md-1" style="margin-bottom:10px;">
          <button type="button" class="fa fa-long-arrow-left" id="link-show-left-menu" rel="true" onclick="javascript:showLeftMenu(true);" data-toggle="tooltip" title="Hide menu" style="height:5px;width:50px;"></button>
        </div>
        <div class="col-md-10" id="alert" >
        </div>
      </div>
    </div>
    <div class="container" style="margin-bottom:60px;min-height:720px;">
      <div class="row">
      </div>
      <input type="hidden" id="page-show" />
      <div class="row">
        <div id="left-menu" class="col-md-4">
        </div>
        <div id="resource-page" class="col-md-8">
        </div>
      </div>
    </div>
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <div class="navbar navbar-inverse navbar-bottom" role="navigation">
            <span style="margin-left:auto;margin-right:auto;"> CosyVerif info server </span>
          </div>
        </div>
      </div>
    </div>

    
<script id="template-search-menu" type="text/x-handlebars-template">
<div style="height:600px;">
  {{#if is_home_project}}
  <div class="row" style="margin-top:30px;">
    <div class="col-md-8">
      <div class="navbar-brand">
        <a href="#">Projects</a>
        
      </div>
    </div>
    <div class="col-md-4">
      <div class="navbar-brand" style="float:right;">
        <a href="#"  rel="select-project-ok"  onclick="searchResources(this)"><i class="fa fa-check-square"></i></a>
        <a href="#"  rel="select-project-no"  onclick="searchResources(this)"><i class="fa fa-square"></i></a>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <div class="btn-group btn-group-justified" style="margin-bottom:8px;"><div class="btn-group"><button type="button" class="btn btn-primary" id="search-button-home" onclick="showHomeOrAll(this)">HOME</button></div><div class="btn-group"><button type="button" class="btn btn-default" id="search-button-all" onclick="showHomeOrAll(this)">ALL</button></div></div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12" id="menu-project-part" style="max-height:500px;overflow:auto;">
        {{{list_projects}}}
    </div>
  </div>
  {{/if}}
  <div class="row">
    <div class="col-md-12" id="menu-project-part">
      <a href="#" onclick="newProject(true)" style="float:right; margin-right:15px;margin-top:5px;"><i class="fa fa-plus"></i></a>
    </div>
  </div>
</div>
<script lang="javascript">
function showHomeOrAll(element)
{
  if ($(element).attr("id") == "search-button-home" && !$(element).hasClass("btn-primary"))
  {
    showSearch(true); 
  }
  else if ($(element).attr("id") == "search-button-all" && !$(element).hasClass("btn-primary"))
  {
    $("#menu-project-part").html("");
    loadTemplate("template-search-content", "resource-page", false, {"is_user" : true, "is_search" : true});
    $("#search-button-home").removeClass("btn-primary");
    $("#search-button-home").addClass("btn-default");
    $("#search-button-all").removeClass("btn-default");
    $("#search-button-all").addClass("btn-primary");
    searchResources(null);
  }
}
$("[class='class-double-buttons']").bootstrapSwitch();
</script>
</script>

<script id="template-search-content" type="text/x-handlebars-template">
<div class="row">
  <div class="col-md-7">
    <div class="input-group">
      <input type="text" class="form-control" id="search-zone-input">
      <span class="input-group-btn">
        <button class="btn btn-default" type="button" id="search-zone-button" onclick="searchResources(null)"><i class="fa fa-search"></i></button>
      </span>
    </div>
  </div>
  <div class="col-md-2">
    <input type="checkbox" class="class-double-buttons" data-on-text="ByDate" data-off-text="ByName" checked>
  </div>
  <div class="col-md-1">
    <div style="height:10px;"><a href="#" onclick="fsort(true)"><i class="fa fa-sort-asc fa-2x color-noir" id="search-button-asc" data-toggle="tooltip" title="Sort asc"></i></a></div>
    <div style="height:10px;"><a href="#" onclick="fsort(false)"><i class="fa fa-sort-desc fa-2x color-gris" id="search-button-desc" data-toggle="tooltip" title="Sort desc"></i></a></div>
  </div>
</div>
<div class="row">
  <div class="col-md-12" style="margin-top:15px;">
    <ul class="nav nav-tabs" role="tablist" id="resource-nav-tabs">
     {{#if is_search}}
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#" rel="user" onclick="showNavTab(this,'User');searchResources(null);" id="resource-nav-tabs-user">Users</a>
      </li>
     {{/if}}
     {{#if is_user}}
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#" rel="project" onclick="showNavTab(this,'Project');searchResources(null);" id="resource-nav-tabs-project">Projects</a>
      </li>
     {{/if}}
      <li class="active"  id="resource-nav-tabs-default">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#" rel="model" onclick="showNavTab(this,'Model');searchResources(null);">Models</a>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#" rel="formalism" onclick="showNavTab(this,'Formalism');searchResources(null);">Formalisms</a>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#" rel="execution" onclick="showNavTab(this, 'Execution');searchResources(null);">Executions</a>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#" rel="service" onclick="showNavTab(this, 'Service');searchResources(null);">Services</a>
      </li>
      <li class="dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#" rel="scenario" onclick="showNavTab(this,'Scenario');searchResources(null);">Scenarios</a>
      </li>
    </ul>
  </div>
</div>
<div class="row">
  <div id="resource-list" class="col-md-12">

  </div>
</div>
<script lang="javascript">
function showNavTab(element, varType)
{ 
  $("#resource-nav-tabs").children(".active").attr("class","dropdown");
  var varColor = "";
  var types = "";
  if (element == null && varType == null)
  {
    $("#resource-nav-tabs-default").attr("class","active");
    varColor = "color-"+$("#resource-nav-tabs-default").children("a").attr("rel");
    types = $("#resource-nav-tabs-default").children("a").attr("rel") + "s";
    varType = "Model";
  }
  else if (element != null)
  {
    $(element).parent().attr("class","active");
    types = $(element).attr("rel") + "s";
    varColor = "color-"+$(element).attr("rel");
  }
  else if (varType == "User")
  {
    $("#resource-nav-tabs").children("li").children("a[rel='user']").parent().attr("class", "active");
    varColor = "color-user";
    types = "users";
  }
  else if (varType == "Project")
  {
    $("#resource-nav-tabs").children("li").children("a[rel='project']").parent().attr("class", "active");
    varColor = "color-project";
    types = "projects";
  }
  else if (varType == "Formalism")
  {
    $("#resource-nav-tabs").children("li").children("a[rel='formalism']").parent().attr("class", "active");
    varColor = "color-formalism";
    types = "formalisms";
  }
  else if (varType == "Model")
  {
    $("#resource-nav-tabs").children("li").children("a[rel='model']").parent().attr("class", "active");
    varColor = "color-model";
    types = "models";
  }
  else if (varType == "Service")
  {
    $("#resource-nav-tabs").children("li").children("a[rel='service']").parent().attr("class", "active");
    varColor = "color-service";
    types = "services";
  }
  else if (varType == "Execution")
  {
    $("#resource-nav-tabs").children("li").children("a[rel='execution']").parent().attr("class", "active");
    varColor = "color-execution";
    types = "executions";
  }
  else if (varType == "Scenario")
  {
    $("#resource-nav-tabs").children("li").children("a[rel='scenario']").parent().attr("class", "active");
    varColor = "color-scenario";
    types = "scenarios";
  }

  varSearchResults = {"color_resource" : varColor, "type" : varType, "resource_list" : {}, "is_edit" : false};
}

showNavTab(null, null);

$("[class='class-double-buttons']").bootstrapSwitch();
</script>
</script>



<script id="template-attribut-show" type="text/x-handlebars-template">
<div class="col-md-10">
  <span id="{{attribut_id}}-input" style="font-weight:bold;">{{attribut_value}}</span>
</div>
<div class="col-md-2">
  {{#if is_edit}}
    <a href="#" id="{{attribut_id}}-button-update" style="display:inline;float:right;" rel="{{attribut_id}}" onclick="modifyAttributs('{{attribut_id}}','{{attribut_value}}')" data-toggle="tooltip" title="Update">
  {{/if}}
    <i class="fa fa-pencil-square-o"></i>
  {{#if is_edit}}
    </a>
  {{/if}}
</div>
</script>

<script id="template-attribut-edition" type="text/x-handlebars-template">
<div class="col-md-10">
  <span id="{{attribut_id}}-label" style="display:none;font-weight:bold;">{{attribut_value}}</span>
  <input type="text" class="form-control" id="{{attribut_id}}-input" placeholder="{{placeholder}}" style="display:inline;" value="{{attribut_value}}">
</div>
<div class="col-md-2">
  <a href="#" id="{{attribut_id}}-button-cancel" onclick="cancelAttributs('{{attribut_id}}')" style="display:inline;float:right;" data-toggle="tooltip" title="Cancel"><i class="fa fa-undo"></i></a>
  <a href="#" id="{{attribut_id}}-button-save" onclick="saveAttributs('{{attribut_id}}','{{attribut_value}}')" style="display:inline;float:right;" data-toggle="tooltip" title="Save"><i class="fa fa-check"></i></a>
</div>
</script>

<script id="template-textarea-show" type="text/x-handlebars-template">
<div class="col-md-10">
  <p id="{{attribut_id}}-input">{{attribut_value}}</p>
</div>
<div class="col-md-2">
  {{#if is_edit}}
    <a href="#" id="{{attribut_id}}-button-update" style="display:inline;float:right;" rel="{{attribut_id}}" onclick="modifyAttributs('{{attribut_id}}','{{attribut_value}}')" data-toggle="tooltip" title="Update">
  {{/if}}
  <i class="fa fa-pencil-square-o"></i>
  {{#if is_edit}}
    </a>
  {{/if}}
</div>
</script>

<script id="template-textarea-edition" type="text/x-handlebars-template">
<div class="col-md-10">
  <p id="{{attribut_id}}-label" style="display:none;">{{attribut_value}}</p>
  <textarea id="{{attribut_id}}-input" class="form-control" rows="5" placeholder="{{placeholder}}" style="display:inline;" >{{attribut_value}}</textarea>
</div>
<div class="col-md-2">
  <a href="#" id="{{attribut_id}}-button-cancel" onclick="cancelAttributs('{{attribut_id}}')" style="display:inline;float:right;" data-toggle="tooltip" title="Cancel"><i class="fa fa-undo"></i></a>
  <a href="#" id="{{attribut_id}}-button-save" onclick="saveAttributs('{{attribut_id}}','{{attribut_value}}')" style="display:inline;float:right;" data-toggle="tooltip" title="Save"><i class="fa fa-check"></i></a>
</div>
</script>

<script id="template-project-menu" type="text/x-handlebars-template">
<div style="height:600px;">
  <div class="row">
    <div class="col-md-12">
      <i id="resource-delete-link" class="fa fa-trash-o"></i>
      <span id="project-rename-link" style="margin-top:3px;"><a href="#" data-toggle="tooltip" title="Rename" onclick="renameResource()"><i class="fa fa-wrench"></i></a><span id="project-rename-text"></span></span>
      <span style="float:right;"><input type="checkbox" class="class-double-buttons" data-size="small" data-on-text="PRIVATE" data-off-text="PUBLIC" id="project-is-public"></span>
    </div>
  </div>
  <div class="row" style="margin-top:10px;" id="project-title"></div>
  <div class="row" style="margin-top:10px;" id="project-description"></div>
  <div class="row" style="margin-top:30px;" id="project-users"></div>
  <div class="row" style="display:none;margin-top:30px;padding-left:15px;padding-right:15px;" id="request-invite">
    <div class="row">
      <div class="col-md-8">
        <div class="input-group">
          <input type="text" class="form-control" placeholder="Invite" id="invite-user">
          <span class="input-group-btn"><button class="btn btn-default" type="button" id="invite-button"><i class="fa fa-send"></i></button></span>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-8">
        <textarea class="form-control" rows="2" placeholder="Invite comment ..." id="invite-comment"></textarea>
      </div>
    </div>
  </div>
  <div class="row" style="margin-top:30px;padding-left:15px;padding-right:15px;" id="project-requests"></div>
</div>

<script lang="javascript">

function successProject(data)
{
  if (data.is_public == true)
    $("#project-is-public").bootstrapSwitch('state', false, true);
  else
    $("#project-is-public").bootstrapSwitch('state', true, true);
  if (data.is_edit == true)
  {
    $("#project-is-public").bootstrapSwitch('readonly', false);
    $("#request-invite").css("display","block");
  }
  else
  {
    $("#project-is-public").bootstrapSwitch('readonly', true);
  }
  if (data.is_delete)
    $("#resource-delete-link").wrap('<a href="javascript:deleteResource(\''+getCurrentURL()+'\',\'\',false)" onclick="javascript:return confirm(\'voulez-vous supprimer cette ressource ?\');">');

  var json = {"attribut_id": "project-title", "attribut_value" : data.name, "is_edit" : data.is_edit};
  loadTemplate("template-attribut-show", "project-title", false, json);

  var json = {"attribut_id": "project-description", "attribut_value" : data.description, "is_edit" : data.is_edit};
  loadTemplate("template-textarea-show", "project-description", false, json);

  $("[class='class-double-buttons']").bootstrapSwitch();
}
function errorProject(jqXHR, textStatus, errorThrown) 
{ 
  showError(jqXHR.status, jqXHR.statusText, "get resource !");
}
get(getCurrentURL(), successProject, errorProject);

function constructUserList()
{
  function success(data)
  {
    if (data.resource_list.length != 0)
    {
      var json = {"list_users": data};
      loadTemplate("template-project-users", "project-users", false, json);
    }

  }
  function error(jqXHR, textStatus, errorThrown) 
  { 
    showError(jqXHR.status, jqXHR.statusText, "get users !");
  }
  get(getCurrentURL() +'/users', success, error);  
}

function constructRequestList()
{
  function success(data)
  {
    if (data.is_edit == true && data.invitations.length != 0)
    {
      var json = {"list_requests": data};
      loadTemplate("template-requests", "project-requests", false, json);
    }
    else
      $("#project-requests").html("");
  }
  function error(jqXHR, textStatus, errorThrown) 
  { 
    showError(jqXHR.status, jqXHR.statusText, "construct requests list of invitations !");
  }
  get(getCurrentURL() +'/invitations?received=true&ack=true&denied=true&canceled=true', success, error);  
}

constructUserList();
constructRequestList();

$('#project-is-public').on('switchChange.bootstrapSwitch', function(event, state) {
  var data = {};
  if (state)
    data = JSON.stringify({"is_public" : false});
  else 
    data = JSON.stringify({"is_public" : true});
  update(getCurrentURL(), data, callBack);
  function callBack(){}
});

function modifyAttributs(attribut_id, attribut_value)
{
  if (attribut_id == "project-title")
  {
    var json = {"attribut_id": attribut_id, "attribut_value" : attribut_value, "placeholder": "Title"};
    loadTemplate("template-attribut-edition", attribut_id, false, json); 
  }
  else if (attribut_id == "project-description")
  {
    var json = {"attribut_id": attribut_id, "attribut_value" : attribut_value, "placeholder": "Description ..."};
    loadTemplate("template-textarea-edition", attribut_id, false, json);
  }
}

function saveAttributs(attribut_id, attribut_value)
{
  if (attribut_id == "project-title")
    var data = JSON.stringify({"name": $("#"+attribut_id+"-input").val()});
  else if (attribut_id == "project-description")
    var data = JSON.stringify({"description": $("#"+attribut_id+"-input").val()});

  update(getCurrentURL(), data, callBack);

  function callBack()
  {
    var json = {"attribut_id": attribut_id, "attribut_value" : $("#"+attribut_id+"-input").val(), "is_edit" : true};
    if (attribut_id == "project-title")
    {
      loadTemplate("template-attribut-show", attribut_id, false, json);
    }
    else if (attribut_id == "project-description")
    {
      loadTemplate("template-textarea-show", attribut_id, false, json);
    }
  }
}

function cancelAttributs(attribut_id)
{
  var json = {"attribut_id": attribut_id, "attribut_value" : $("#"+attribut_id+"-label").text(), "is_edit" : true};
  if (attribut_id == "project-title")
  {
    loadTemplate("template-attribut-show", attribut_id, false, json);
  }
  else if (attribut_id == "project-description")
  {
    loadTemplate("template-textarea-show", attribut_id, false, json);
  }
}

function update(url, data, callBack)
{
  function success(data)
  { 
    callBack();
  }
  function error(jqXHR, textStatus, errorThrown) 
  { 
    showError(jqXHR.status, jqXHR.statusText, "update resource !");
  }
  put(url, data, success, error);
}

function successInvite(data)
{
  var availableTags = [];
  for (var i = 0; i < data.resource_list.length; i++) 
  {
    var tmp = data.resource_list[i].href.split("/");
    availableTags[i] = {label:tmp[tmp.length - 1] +" ("+ data.resource_list[i].name +")", value:tmp[tmp.length - 1]};
  }
  $( "#invite-user").autocomplete( {source: availableTags});
  $( "#invite-user" ).autocomplete( "option", "autoFocus", true);
  $( "#invite-user" ).autocomplete({
    select: function( event, ui ){$("#invite-button").attr("onclick", "sendRequestToUser('"+ui.item.value+"')");}
  });
  $( "#invite-user" ).autocomplete({
    search: function( event, ui ){$("#invite-button").attr("onclick","sendRequestToUser('')");}
  });
}
function errorInvite(jqXHR, textStatus, errorThrown) 
{ 
  showError(jqXHR.status, jqXHR.statusText, "send request invitation !");
}
get("/users", successInvite, errorInvite);

function sendRequestToUser(username)
{ 
  if (username == "" && $("#invite-user").val() == "")
  {
    alertNotification("danger", "Fields is empty");
    return false;
  }
  if (username == "")
  {
    username = $("#join-project").val();
  }
  function success(data)
  { 
    $("#invite-user").val("");
    $("#invite-button").attr("onclick","sendRequestToUser('')");
    $("#invite-comment").val("");
    alertNotification("success", "Request sent !");
  }
  function error(jqXHR, textStatus, errorThrown) 
  { 
    showError(jqXHR.status, jqXHR.statusText, "send request inviation !");
  }
  var data = JSON.stringify({"comment":(($("#invite-comment").val() != "")? $("#invite-comment").val() : "Accept this invitation, please !")});
  post(getCurrentURL()+"/invitations/"+username, data, success, error);
}

$("[class='class-double-buttons']").bootstrapSwitch();
</script>
</script>

<script id="template-project-users" type="text/x-handlebars-template">
<div class="col-md-12">
  <span>Users :</span>
  <div style="height:150px;overflow:auto;margin-top:5px;">
    <table class="table table-bordered">
          
  {{#each list_users.resource_list}}
    <tr>
      <td style="padding:0px;">
       {{#if this.is_read}}<a href="#" onclick="showUser('{{this.href}}');">{{/if}} {{this.name}} {{#if this.is_read}}</a>{{/if}}
      </td>
      <td style="padding:0px 5px 0px 5px;width:10px;"><input type="checkbox" class="class-double-buttons permission-admin" name="my-checkbox" data-size="small" data-on-text="ADMIN" data-off-text="?" value="{{this.href}}" {{#unless this.is_edit}} readonly="true" {{/unless}} {{#if this.is_admin_project}} checked {{/if}}></td>
      <td style="padding:0px 5px 0px 5px;width:10px;"><input type="checkbox" class="class-double-buttons permission-edit" name="my-checkbox" data-size="small" data-on-text="WRITE" data-off-text="READ" value="{{this.href}}" {{#unless this.is_edit}} readonly="true" {{/unless}} {{#if this.is_edit_project}} checked {{/if}}></td>
      <td style="padding-top:0px;padding-bottom:5px; width:10px;">
        {{#if this.is_delete}}<a href="javascript:deleteUser('{{this.href}}');" onclick="javascript:return confirm('voulez-vous supprimer cette ressource ?');">{{/if}}
          <i class="fa fa-trash-o"></i>
        {{#if this.is_delete}}</a>{{/if}}
      </td>
    </tr>
  {{/each}}

    </table>
  </div>
</div>

<script lang="javascript">

$('.permission-admin').on('switchChange.bootstrapSwitch', function(event, state) {
  var data = {};
  if (state)
    data = JSON.stringify({"is_admin_project" : true});
  else 
    data = JSON.stringify({"is_admin_project" : false});
  update(getCurrentURL() + $(this).val(), data, callBack);
  function callBack(){}
});

$('.permission-edit').on('switchChange.bootstrapSwitch', function(event, state) {
  var data = {};
  if (state)
    data = JSON.stringify({"is_edit_project" : true});
  else 
    data = JSON.stringify({"is_edit_project" : false});
  update(getCurrentURL() + $(this).val(), data, callBack);
  function callBack(){}
});

function update(url, data, callBack)
{
  function success(data)
  { 
    callBack();
  }
  function error(jqXHR, textStatus, errorThrown) 
  { 
    showError(jqXHR.status, jqXHR.statusText, "update permissions !");
  }
  put(url, data, success, error);
}

function deleteUser(url)
{
  function success(data)
  {
    showSearch(true);
  }
  function error(jqXHR, textStatus, errorThrown) 
  { 
    showError(jqXHR.status, jqXHR.statusText, "delete user !");
  }
  del(getCurrentURL()+url, success, error);
}

$(".permission-admin").bootstrapSwitch();
$(".permission-edit").bootstrapSwitch();

</script>
</script>

<script id="template-requests" type="text/x-handlebars-template">
<div class="row">
  <div class="col-md-12">
    <span>Requests :</span>
    <div style="height:150px;overflow:auto;margin-top:5px;">
      <table class="table table-bordered">
        {{#each list_requests.invitations}}
          <tr>
            <td style="display:block;"><span style="font-weight:bold;">{{this.name}}</span><p>{{this.comment}}</p></td>
            <td style="display:none;">
              <div class="input-group">
                <input type="text" class="form-control" placeholder="Comment ...">
                <span class="input-group-btn"><button class="btn btn-default" type="button"><i class="fa fa-send"></i></button></span>
              </div>
            </td>
            <td style="width:80px;">
              {{#if this.is_eye}}<a href="#" id="project-description-button-save" style="display:inline;float:right;margin-left:2px;" rel="project-title" onclick="viewRequest('{{this.href}}','{{this.timestamp}}')"><i class="fa fa-eye"></i></a>{{/if}}
              {{#if this.is_comment}}<a href="#" id="project-description-button-update" style="display:inline;float:right;margin-left:2px;" rel="project-title" onclick="editComment('{{this.href}}','{{this.timestamp}}',this)"><i class="fa fa-comment"></i></a>{{/if}}
              {{#if this.is_cancel}}<a href="#" id="project-description-button-cancel" style="display:inline;float:right;margin-left:2px;" rel="project-title" onclick="downRequest('{{this.href}}','{{this.timestamp}}')"><i class="fa fa-thumbs-down"></i></a>{{/if}}
              {{#if this.is_ack}}<a href="#" id="project-description-button-save" style="display:inline;float:right;margin-left:2px;" rel="project-title" onclick="acceptRequest('{{this.href}}','{{this.timestamp}}')"><i class="fa fa-thumbs-up"></i></a>{{/if}}
            </td>
          </tr>
        {{/each}}
      </table>
    </div>
  </div>
</div>
<script lang="javascript">

function acceptRequest(url, timestamp)
{
  function success(data)
  { 
    if ($("#page-show").val() == "user")
    {
      constructProjectList();
      constructRequestList();
    }
    else if ($("#page-show").val() == "project")
    {
      constructUserList();
      constructRequestList();
    }
    
  }
  function error(jqXHR, textStatus, errorThrown) 
  { 
    showError(jqXHR.status, jqXHR.statusText, "accept request !");
  }
  var data = JSON.stringify({"comment":"Accepted !", "timestamp" : timestamp, "status" : "ack"});
  put(url, data, success, error);
}

function downRequest(url, timestamp)
{
  function success(data)
  { 
    constructRequestList();
  }
  function error(jqXHR, textStatus, errorThrown) 
  { 
    showError(jqXHR.status, jqXHR.statusText, "down request !");
  }
  var data = JSON.stringify({"comment":"Denied !", "timestamp" : timestamp, "status" : "denied"});
  put(url, data, success, error);
}

function editComment(url, timestamp, element)
{
 $(element).parent().prev().prev().css("display","none");
 $(element).parent().prev().css("display","block");
 $(element).parent().prev().children().find("button").attr("onclick","commentRequest('"+url+"','"+timestamp+"',this)");
}
function commentRequest(url, timestamp, element)
{
  function success(data)
  { 
    constructRequestList();
  }
  function error(jqXHR, textStatus, errorThrown) 
  { 
    showError(jqXHR.status, jqXHR.statusText, "comment request !");
  }
  var data = JSON.stringify({"comment":$(element).parent().prev().val(), "timestamp" : timestamp, "status" : "comment"});
  put(url, data, success, error);
}

function viewRequest(url, timestamp)
{
  function success(data)
  { 
    constructRequestList();
  }
  function error(jqXHR, textStatus, errorThrown) 
  { 
    showError(jqXHR.status, jqXHR.statusText, "view request !");
  }
  var data = JSON.stringify({"comment":"Accepted !", "timestamp" : timestamp, "status" : "view"});
  put(url, data, success, error);
}

</script>
</script>

<script id="template-user-menu-profile" type="text/x-handlebars-template">
<div class="row" style="margin-top:10px;margin-bottom:20px;">
  <div class="col-md-12">
    <i id="resource-delete-link" class="fa fa-trash-o"></i>
    <span id="user-rename-link" style="margin-top:3px;"><a href="#" data-toggle="tooltip" title="Rename" onclick="renameResource()"><i class="fa fa-wrench"></i></a><span id="user-rename-text"></span></span>
    <span style="float:right;"><input type="checkbox" class="class-double-buttons" data-size="small" data-on-text="PRIVATE" data-off-text="PUBLIC" id="user-is-public"></span>
  </div>
</div>
<div class="row" style="margin-top:10px;" id="user-firstname"></div>
<div class="row" style="margin-top:10px;" id="user-lastname"></div>
<div class="row" style="margin-top:10px;" id="user-email"></div>
<div class="row" style="margin-top:10px;" id="user-username"></div>
<script lang="javascript">

function success(data)
{
  if (data.is_public == true)
    $("#user-is-public").bootstrapSwitch('state', false);
  else
    $("#user-is-public").bootstrapSwitch('state', true);
  if (data.is_edit)
  {
    $("#user-is-public").bootstrapSwitch('readonly', false, true);
    $("#request-join").css("display","block");
  }
  else
  {
    $("#user-is-public").bootstrapSwitch('readonly', true, true);
  }
  if (data.is_delete)
    $("#resource-delete-link").wrap('<a href="javascript:deleteResource(\''+getCurrentURL()+'\',\'\',false)" onclick="javascript:return confirm(\'voulez-vous supprimer cette ressource ?\');">');
  var json = {"attribut_id": "user-firstname", "attribut_value" : data.first_name, "is_edit" : data.is_edit};
  loadTemplate("template-attribut-show", "user-firstname", false, json);

  var json = {"attribut_id": "user-lastname", "attribut_value" : data.last_name, "is_edit" : data.is_edit};
  loadTemplate("template-attribut-show", "user-lastname", false, json);

  var json = {"attribut_id": "user-email", "attribut_value" : data.email, "is_edit" : data.is_edit};
  loadTemplate("template-attribut-show", "user-email", false, json);

  var json = {"attribut_id": "user-username", "attribut_value" : data.login, "is_edit" : data.is_edit};
  loadTemplate("template-attribut-show", "user-username", false, json);

  $("[class='class-double-buttons']").bootstrapSwitch();
}
function error(jqXHR, textStatus, errorThrown) 
{ 
  showError(jqXHR.status, jqXHR.statusText, "update resource !");
}
get(getCurrentURL(), success, error);
</script>
</script>

<script id="template-user-menu" type="text/x-handlebars-template">
<div style="height:600px;">
  <div class="row" style="margin-top:10px;padding-left:15px;padding-right:15px;" id="user-profile"></div>
  <div class="row" style="margin-top:40px;" id="user-projects"></div>
  <div class="row" style="display:none;margin-top:30px;padding-left:15px;padding-right:15px;" id="request-join">
    <div class="row">
      <div class="col-md-8">
        <div class="input-group">
          <input type="text" class="form-control" id="join-project" placeholder="Join">
          <span class="input-group-btn"><button class="btn btn-default" type="button" id="join-button" onclick="javascript:sendRequestToProject('');" data-toggle="tooltip" title="Send"><i class="fa fa-send"></i></button></span>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-8">
        <textarea class="form-control" id="join-comment" rows="2" placeholder="Join comment ..."></textarea>
      </div>
    </div>
  </div>
  <div class="row" style="margin-top:30px;padding-left:15px;padding-right:15px;" id="user-requests"></div>
</div>
<script lang="javascript">
function constructProjectList()
{
  function success(data)
  {
    var json = {"list_projects": data};
    loadTemplate("template-user-projects", "user-projects", false, json);
  }
  function error(jqXHR, textStatus, errorThrown) 
  { 
    showError(jqXHR.status, jqXHR.statusText, "construct project list !");
  }
  get(getCurrentURL() +'/projects', success, error);  
}

function constructProfile()
{ 
  loadTemplate("template-user-menu-profile", "user-profile", false, {});
}

function constructRequestList()
{
  function success(data)
  {
    if (data.is_edit == true && data.invitations.length != 0)
    {
      var json = {"list_requests": data};
      loadTemplate("template-requests", "user-requests", false, json);
    }
    else
      $("#user-requests").html("");
  }
  function error(jqXHR, textStatus, errorThrown) 
  { 
      showError(jqXHR.status, jqXHR.statusText, "construct requests list of invitations !");
  }
  get(getCurrentURL() +'/invitations?received=true&ack=true&denied=true&canceled=true', success, error);  
}


constructProfile();
constructProjectList();
constructRequestList();

$('#user-is-public').on('switchChange.bootstrapSwitch', function(event, state) {
  var data = {};
  if (state)
    data = JSON.stringify({"is_public" : false});
  else 
    data = JSON.stringify({"is_public" : true});
  update(getCurrentURL(), data, callBack);
  function callBack(){}
});

function modifyAttributs(attribut_id, attribut_value)
{
  if (attribut_id == "user-firstname")
    var placeholder = "Firstname";
  else if (attribut_id == "user-lastname")
    var placeholder = "Lastname";
  else if (attribut_id == "user-email")
    var placeholder = "Email";
  else if (attribut_id == "user-username")
    var placeholder = "Username";
  var json = {"attribut_id": attribut_id, "attribut_value" : attribut_value, "placeholder": placeholder};
  loadTemplate("template-attribut-edition", attribut_id, false, json); 
}

function saveAttributs(attribut_id, attribut_value)
{
  if (attribut_id == "user-firstname")
    var data = JSON.stringify({"first_name": $("#"+attribut_id+"-input").val()});
  else if (attribut_id == "user-lastname")
    var data = JSON.stringify({"last_name": $("#"+attribut_id+"-input").val()});
  else if (attribut_id == "user-email")
    var data = JSON.stringify({"email": $("#"+attribut_id+"-input").val()});
  else if (attribut_id == "user-username")
    var data = JSON.stringify({"login": $("#"+attribut_id+"-input").val()});

  update(getCurrentURL(), data, callBack);

  function callBack()
  {
    var json = {"attribut_id": attribut_id, "attribut_value" : $("#"+attribut_id+"-input").val(), "is_edit" : true};
    if (attribut_id == "user-firstname")
    {
      setUserName($("#user-firstname-input").val() + " " + $("#user-lastname-input").text());
      showLoginLogout();
    } 
    else if (attribut_id == "user-lastname")
    {
      setUserName($("#user-firstname-input").text() + " " + $("#user-lastname-input").val());
      showLoginLogout();
    }
    loadTemplate("template-attribut-show", attribut_id, false, json);
  }
}

function cancelAttributs(attribut_id)
{
  var json = {"attribut_id": attribut_id, "attribut_value" : $("#"+attribut_id+"-label").text(), "is_edit" : true};
  loadTemplate("template-attribut-show", attribut_id, false, json);
}

function update(url, data, callBack)
{
  function success(data)
  { 
    callBack();
  }
  function error(jqXHR, textStatus, errorThrown) 
  { 
    showError(jqXHR.status, jqXHR.statusText, "update resource !");
  }
  put(url, data, success, error);
}

function deleteProject(url)
{
  function success(data)
  {
    constructProjectList();
  }
  function error(jqXHR, textStatus, errorThrown) 
  { 
    showError(jqXHR.status, jqXHR.statusText, "delete resource !");
  }
  del(getCurrentURL()+url, success, error);
}

function successJoin(data)
{
  var availableTags = [];
  for (var i = 0; i < data.resource_list.length; i++) 
  {
    var tmp = data.resource_list[i].href.split("/");
    availableTags[i] = {label:tmp[tmp.length - 1] +" ("+ data.resource_list[i].name +")", value:tmp[tmp.length - 1]};
  }
  $( "#join-project").autocomplete( {source: availableTags});
  $( "#join-project" ).autocomplete( "option", "autoFocus", true);
  $( "#join-project" ).autocomplete({
    select: function( event, ui ){$("#join-button").attr("onclick", "sendRequestToProject('"+ui.item.value+"')");}
  });
  $( "#join-project" ).autocomplete({
    search: function( event, ui ){$("#join-button").attr("onclick","sendRequestToProject('')");}
  });
}
function errorJoin(jqXHR, textStatus, errorThrown) 
{ 
  showError(jqXHR.status, jqXHR.statusText, "request invitation !");
}
get("/projects", successJoin, errorJoin);

function sendRequestToProject(project_name)
{ 
  if (project_name == "" && $("#join-project").val() == "")
  {
    alertNotification("danger", "Fields is empty");
    return false;
  }
  if (project_name == "")
  {
    project_name = $("#join-project").val();
  }
  function success(data)
  { 
    $("#join-project").val("");
    $("#join-button").attr("onclick","sendRequestToProject('')");
    $("#join-comment").val("");
    alertNotification("success", "Request sent !");
  }
  function error(jqXHR, textStatus, errorThrown) 
  { 
    showError(jqXHR.status, jqXHR.statusText, "request invitation !");
  }
  var data = JSON.stringify({"comment":(($("#join-comment").val() != "")? $("#join-comment").val() : "Add me this project, please !")});
  post("/users/"+getUserLogin()+"/invitations/"+project_name, data, success, error);
}

$("[class='class-double-buttons']").bootstrapSwitch();
  
</script>
</script>

<script id="template-user-projects" type="text/x-handlebars-template">
<div class="col-md-12">
  <div style="width:100%;"><span>Projects :</span>
    <span style="float:right;">
      {{#if list_projects.is_create}}<a href="#" onclick="newProject(false)">{{/if}}
      <i class="fa fa-plus fa-1x"></i>
      {{#if list_projects.is_create}}</a>{{/if}}
    </span>
  </div>
  <div style="height:150px;overflow:auto;margin-top:5px;">
    <table class="table table-bordered">
          
  {{#each list_projects.resource_list}}
    <tr>
      <td>
      {{#if this.is_read}}
        <a href="#" onclick="showProject('{{this.href}}')">
      {{/if}}
          <span style="width:100%;height:100%;">{{this.name}}</span>
      {{#if this.is_read}}
        </a>
      {{/if}}
      </td>
      <td style="padding:0px 5px 0px 5px;width:150px;">
        <div class="input-group">
          <input type="text" class="form-control autocompletion_users" placeholder="Invite" {{#unless this.is_edit}} disabled="true" {{/unless}}>
          <input type="hidden" value="{{this.href}}"/>
          <span class="input-group-btn"><button class="btn btn-default" type="button" onclick="javascript:sendRequestToUser(this,'');" data-toggle="tooltip" title="Send" {{#unless this.is_edit}} disabled="true" {{/unless}}><i class="fa fa-send"></i></button></span>
        </div>
      </td>
      <td style="padding-top:0px;padding-bottom:5px; width:10px;">
        {{#if this.is_delete}}
         <a href="javascript:deleteProject('{{this.href}}');" onclick="javascript:return confirm('voulez-vous supprimer cette ressource ?');" data-toggle="tooltip" title="Remove"> 
        {{/if}}
         <i class="fa fa-trash-o"></i>
        {{#if this.is_delete}}
          </a>
        {{/if}}
      </td>
    </tr>
  {{/each}}

    </table>
  </div>
</div>
<script lang="javascript">

function success(data)
{
  var availableTags = [];
  for (var i = 0; i < data.resource_list.length; i++) 
  {
    var tmp = data.resource_list[i].href.split("/");
    availableTags[i] = {label:tmp[tmp.length - 1] +" ("+ data.resource_list[i].name +")", value:tmp[tmp.length - 1]};
  }
  $( ".autocompletion_users" ).autocomplete( {source: availableTags});
  $( ".autocompletion_users" ).autocomplete( "option", "autoFocus", true);
  $( ".autocompletion_users" ).autocomplete({
    select: function( event, ui ){$(this).next().next().children("button").attr("onclick", "sendRequestToUser(this,'"+ui.item.value+"')");}
  });
  $( ".autocompletion_users" ).autocomplete({
    search: function( event, ui ){$(this).next().next().children("button").attr("onclick","sendRequestToUser(this,'')");}
  });
}
function error(jqXHR, textStatus, errorThrown) 
{ 
  showError(jqXHR.status, jqXHR.statusText, "get user list !");
}
get("/users", success, error);

function sendRequestToUser(element, username)
{ 
  if (username == "" && $(element).parent().prev().prev().val() == "")
  {
    alertNotification("danger", "Fields is empty");
    return false;
  }
  if (username == "")
  {
    username = $(element).parent().prev().prev().val();
  }
  
  function success(data)
  { 
    $(element).parent().prev().prev().val("");
    $(element).attr("onclick","sendRequestToUser(this,'')");
    alertNotification("success", "Request sent !");
  }
  function error(jqXHR, textStatus, errorThrown) 
  { 
    showError(jqXHR.status, jqXHR.statusText, "request invitation !");
  }
  var data = JSON.stringify({"comment":"Accept this invitation, please !"});
  post($(element).parent().prev().val()+"/invitations/"+username, data, success, error);
}
$("[class='class-double-buttons']").bootstrapSwitch();
</script>
</script>

<script id="template-user-new" type="text/x-handlebars-template">
<div class="row">
  <div class="col-md-6 col-md-offset-3">
    <div class="form-group">
      <label class="control-label" for="inputSuccess1"></label>
      <input type="text" class="form-control" id="user-firstname" placeholder="Firstname">
    </div>
  </div>
</div>
<div class="row">
  <div class="col-md-6 col-md-offset-3">
    <div class="form-group"> 
      <input type="text" class="form-control" id="user-lastname" placeholder="Lastname">
    </div>
  </div>
</div>
<div class="row">
  <div class="col-md-6 col-md-offset-3">
    <div class="form-group"> 
      <input type="text" class="form-control" id="user-username" placeholder="Username">
    </div>
  </div>
</div>
<div class="row">
  <div class="col-md-6 col-md-offset-3">
    <div class="form-group"> 
      <div class="input-group">
        <span class="input-group-addon"><i class="fa fa-key fa-fw"></i></span>
        <input class="form-control" type="password" id="user-password" placeholder="Password">
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-md-6 col-md-offset-3">
    <div class="form-group"> 
      <div class="input-group">
        <span class="input-group-addon"><i class="fa fa-key fa-fw"></i></span>
        <input class="form-control" type="password" id="user-confirmation" placeholder="Confirmation">
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-md-6 col-md-offset-3">
    <div class="form-group">
      <div class="input-group">
        <div class="input-group-addon">&nbsp;@&nbsp;</div>
        <input class="form-control" type="email" id="user-email" placeholder="Email">
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-md-1 col-md-offset-5">
    <a href="#" style="float:right;" id="user-button-save"><i class="fa fa-check-square fa-2x"></i></a>
  </div>
</div>

<script lang="javascript">
$("#user-username").val($("#usernamePlaceHolder").val());
$("#user-password").val($("#passwordPlaceHolder").val());

$("#user-button-save").click(function(){
  if ($("#user-username").val() == "" || $("#user-password").val() == "" || $("#user-email").val() == "" || $("#user-firstname").val() == "" || $("#user-lastname").val() == "" || $("#user-confirmation").val() == "")
  {
    alertNotification("danger", "empty fields !");
    return;
  }
  else if ($("#user-password").val() != $("#user-confirmation").val())
  {
    alertNotification("danger", "Password not correct !");
    $("#user-password").val("");
    $("#user-confirmation").val("");
    return;
  }
  function success(data)
  { 
    alertNotification("success", "Your account is created, please check your email to activate");
    showSearch(true);
  }
  function error(jqXHR, textStatus, errorThrown) { showError(jqXHR.status, jqXHR.statusText, "get user !");}
  var jsonData = JSON.stringify({"request_type" : "create",
                                 "first_name" : $("#user-firstname").val(),
                                 "last_name" : $("#user-lastname").val(),
                                 "email" : $("#user-email").val(),
                                 "login":$("#user-username").val(),
                                 "password":$("#user-password").val()
                                });
  post("/users/" + $("#user-username").val(), jsonData, success, error);
});
</script>

</script>

<script id="template-resource-menu" type="text/x-handlebars-template">
<div style="height:600px;">
  <div class="row" style="margin-top:10px;">
    <div class="col-md-12">
      <i id="resource-delete-link" class="fa fa-trash-o"></i>
      <span id="resource-rename-link" style="margin-top:3px;"><a href="#" data-toggle="tooltip" title="Rename" onclick="renameResource()"><i class="fa fa-wrench"></i></a><span id="resource-rename-text"></span></span>
      <span id="resource-type" style="float:left;"></span><a id="resource-project" href="#" style="float:right;"></a>
    </div>
  </div>
  <div class="row" style="margin-top:10px;" id="resource-title"></div>
  <div class="row" style="margin-top:10px;" id="resource-description"></div>
  <div class="row" style="margin-top:10px;padding-left:15px;" id="resource-path" style="text-align:right;"></div>
  <div class="row" style="margin-top:30px;" id="resource-suite"></div>
</div>

<script lang="javascript">

function successResource(data)
{
  $("#resource-project").text(data.project_type + " : " + data.project_name);
  $("#resource-project").attr("rel",data.project_type);
  $("#resource-project").attr("onclick","showResource(this,'"+data.project_url+"')");
  $("#resource-path").text("Path : " + getServerURL()+getCurrentURL());

  if (data.is_delete)
    $("#resource-delete-link").wrap('<a href="javascript:deleteResource(\''+getCurrentURL()+'\',\'\',false)" onclick="javascript:return confirm(\'voulez-vous supprimer cette ressource ?\');">');

  var json = {"attribut_id": "resource-title", "attribut_value" : data.name, "is_edit" : data.is_edit};
  loadTemplate("template-attribut-show", "resource-title", false, json);

  var json = {"attribut_id": "resource-description", "attribut_value" : data.description, "is_edit" : data.is_edit};
  loadTemplate("template-textarea-show", "resource-description", false, json);

  $("[class='class-double-buttons']").bootstrapSwitch();
}
function errorResource(jqXHR, textStatus, errorThrown) 
{ 
  showError(jqXHR.status, jqXHR.statusText, "get resource !");
}
get(getCurrentURL(), successResource, errorResource);

function modifyAttributs(attribut_id, attribut_value)
{
  if (attribut_id == "resource-title")
  {
    var json = {"attribut_id": attribut_id, "attribut_value" : attribut_value, "placeholder": "Title"};
    loadTemplate("template-attribut-edition", attribut_id, false, json); 
  }
  else if (attribut_id == "resource-description")
  {
    var json = {"attribut_id": attribut_id, "attribut_value" : attribut_value, "placeholder": "Description ..."};
    loadTemplate("template-textarea-edition", attribut_id, false, json);
  }
}

function saveAttributs(attribut_id, attribut_value)
{
  if (attribut_id == "resource-title")
    var data = JSON.stringify({"name": $("#"+attribut_id+"-input").val()});
  else if (attribut_id == "resource-description")
    var data = JSON.stringify({"description": $("#"+attribut_id+"-input").val()});

  update(getCurrentURL(), data, callBack);

  function callBack()
  {
    var json = {"attribut_id": attribut_id, "attribut_value" : $("#"+attribut_id+"-input").val(), "is_edit" : true};
    if (attribut_id == "resource-title")
    {
      loadTemplate("template-attribut-show", attribut_id, false, json);
    }
    else if (attribut_id == "resource-description")
    {
      loadTemplate("template-textarea-show", attribut_id, false, json);
    }
  }
}

function cancelAttributs(attribut_id)
{
  var json = {"attribut_id": attribut_id, "attribut_value" : $("#"+attribut_id+"-label").text(), "is_edit" : true};
  if (attribut_id == "resource-title")
  {
    loadTemplate("template-attribut-show", attribut_id, false, json);
  }
  else if (attribut_id == "resource-description")
  {
    loadTemplate("template-textarea-show", attribut_id, false, json);
  }
}

function update(url, data, callBack)
{
  function success(data)
  { 
    callBack();
  }
  function error(jqXHR, textStatus, errorThrown) 
  { 
    showError(jqXHR.status, jqXHR.statusText, "update resource !");
  }
  put(url, data, success, error);
}
</script>
</script>

<script id="template-resource-content" type="text/x-handlebars-template">
<div class="row">
  <div class="col-md-12">
    <div id="model_container" class="span9"></div>
    <a href="javascript:suo()">show</a>
  </div>
</div>
<script type="text/javascript" src="js/lua.vm.js"></script>
<script type="text/javascript" src="js/editor.js"></script>
<script lang="javascript">
Lua.executeScript = function(src) {
  var xhr = new XMLHttpRequest();
  xhr.open("GET", src, false);
  xhr.send(null);
  if (xhr.readyState == 4 && (xhr.status == 200 || xhr.status == 0)) {
    console.log("Downloaded Lua script: " + src);
    L.execute(xhr.responseText);
    console.log("Executed Lua script: " + src);
  } else {
    console.log("Unable to fetch Lua script: " + src);
  }
};
Lua.executeScript("lua/js.lua");
Lua.executeScript("lua/cosy.lua");
Cosy.configure_editor("ws://edit.cosyverif.io")
Cosy.configure_server("http://rest.cosyverif.io:8080/", {
  username: "alban",
  password: "toto"
});

function suo(){
  change_size_svg('400','400');
}
</script>
</script>

<script id="template-resource-new" type="text/x-handlebars-template">
<div class="row">
  <div class="col-md-6 col-md-offset-3">
    <div class="form-group has-success">
      <label class="control-label" for="inputSuccess1"></label>
      <input type="text" class="form-control" id="resource-name" placeholder="{{type}} name">
    </div>
  </div>
</div>
<div class="row">
  <div class="col-md-6 col-md-offset-3">
    <div class="form-group has-success">
      <input type="text" class="form-control" id="resource-title" placeholder="{{type}} title">
    </div>
  </div>
</div>
<div class="row">
  <div class="col-md-6 col-md-offset-3">
    <textarea id="resource-description" class="form-control" rows="4" placeholder="{{type}} description ..."></textarea>
  </div>
</div>
<div class="row">
  <div class="col-md-1 col-md-offset-5" style="text-align:center;">
    <a href="#" onclick="saveResource('{{type}}')"><i class="fa fa-check-square fa-2x"></i></a>
  </div>
</div>
<script lang="javascript">
function saveResource(type)
{
  if ($("#resource-title").val() == "" || $("#resource-description").val() == "" || $("#resource-name").val() == "")
  {
    alertNotification("danger", "Fields is empty !");
    return;
  }
  var types = "";
  if (type == "Formalism")
    types = "formalisms";
  else if (type == "Model")
    types = "models";
  else if (type == "Service")
    types = "services";
  else if (type == "Execution")
    types = "executions";
  else if (type == "Scenario")
    types = "scenarios";
  else if (type == "Project")
    types = "projects";
  var url = getCurrentURL() +'/'+types+'/' + $("#resource-name").val();
  function success(data)
  {
    if (type == "Project")
    {
      constructProjectList();
      loadTemplate("template-search-content", "resource-page", false, {"is_user" : ($("#page-show").val() == "user" || $("#page-show").val() == "search"), "is_search" : ($("#page-show").val() == "search")});
      showNavTab(null, "Project");
      searchResources(null);
    }
    else
      showBase(url);
  }
  function error(jqXHR, textStatus, errorThrown) 
  { 
    showError(jqXHR.status, jqXHR.statusText, "create resource !");
  }
  var data = JSON.stringify({"name" : $("#resource-title").val(),
                             "description" : $("#resource-description").val()
                            });
  post(url, data, success, error);
}
</script>
</script>

<script id="template-search-result" type="text/x-handlebars-template">
<div class="{{color}}" style="margin:5px;height:150px;padding:5px 5px 0px 5px;color: inherit; border-radius: 6px;">
  <div style="float:right;">
    {{#if is_copy}}
    <a href="#" style="display:inline;" onclick="javascript:copyResource('{{href}}');" data-toggle="modal" data-target="#modal-copy-move"><i class="fa fa-files-o"></i></a>
    {{/if}}
    {{#if is_move}}
    <a href="#" style="display:inline;" onclick="javascript:moveResource('{{href}}');" data-toggle="modal" data-target="#modal-copy-move"><i class="fa fa-scissors"></i></a>
    {{/if}}
    {{#if is_delete}}
    <a href="javascript:deleteResource('{{href}}','{{type}}', true)" style="display:inline;" onclick="javascript:return confirm('voulez-vous supprimer cette ressource ?');"><i class="fa fa-trash-o"></i></a>
    {{/if}}
  </div>
  <a href="#" rel="{{type}}" onclick="showResource(this,'{{href}}')">
    <div style="width:100%;height:100%;">
      <div><i {{#if logo}} class="fa fa-user" {{else}} class="fa fa-group" {{/if}}></i> <span>{{project}}</span></div>
      <div style="display:block;margin-top:10px;font-weight:bold;">{{name}}</div>
      <p style="margin-top:5px;min-height:40px;">{{description}}</p>
      <div style="margin-top:5px;float:right;">{{type}}</div>
    </div>
  </a>
</div>
</script>

<script id="template-modal-copy-move" type="text/x-handlebars-template">
<div class="modal fade" id="modal-copy-move" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel">{{title}}</h4>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-12">
            <div class="input-group">
              <input type="text" class="form-control">
              <span class="input-group-btn">
                <button class="btn btn-default" type="button"><i class="fa fa-search"></i></button>
              </span>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <select multiple class="form-control" size="10" style="margin-top:3px;" onclick="javascript: document.getElementById('modal-button-ok').disabled = ''">
              <option>User en cours</option>
              <option>Project 1</option>
              <option>Project 2</option>
              <option>Project 3</option>
              <option>Project 4</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="modal-button-ok" disabled="true" type="button" class="btn btn-primary" data-dismiss="modal" onclick="javascript:actionResource('{{action}}','{{src}}')" >Ok</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button> 
      </div>
    </div>
  </div>
</div>
<script lang="javascript">
  function actionResource (action, src) {
    if (action == "copy"){
      alert("copy " +src);
    }
    else if (action == "move")
    {
      alert("move " + src);
    }
  }
</script>
</script>

<script lang="javascript">

varSearchResults = {"color_resource" : "", "type" : "", "resource_list" : {}, "is_edit" : false};

function showLeftMenu(show)
{
  if (show == false)
  {
    $("#link-show-left-menu").css("display","none");
    $("#left-menu").css('display', 'none')
                   .css('visibility','hidden');
    $("#resource-page").attr("class","col-md-12");

    if( $("#page-show").val() == "resource")
      change_size_svg('1000','1100');
  }
  else if ($("#link-show-left-menu").attr("rel") == "true")
  {
    $("#link-show-left-menu").css("display","inline");
    $("#link-show-left-menu").attr("rel","false");
    $("#link-show-left-menu").attr("title", "Show menu");
    $("#link-show-left-menu").attr("class","fa fa-long-arrow-right");
    $("#left-menu").css('display', 'none')
                   .css('visibility','hidden');
    $("#resource-page").attr("class","col-md-12");

    if (($("#page-show").val() == "search" || $("#page-show").val() == "project" || $("#page-show").val() == "user") && $("#search-showing").val() == "true")
    {
      showResultSearch(false);
    }
    else if( $("#page-show").val() == "resource")
      change_size_svg('1000','1100');
  }
  else
  {
    $("#link-show-left-menu").css("display","inline");
    $("#link-show-left-menu").attr("rel","true");
    $("#link-show-left-menu").attr("title", "Hide menu");
    $("#link-show-left-menu").attr("class","fa fa-long-arrow-left");
    $("#left-menu").css('display', 'block')
                   .css('visibility','visible');
    $("#resource-page").attr("class","col-md-8");

    if (($("#page-show").val() == "search" || $("#page-show").val() == "project" || $("#page-show").val() == "user")  && $("#search-showing").val() == "true")
    {
      showResultSearch(true);
    }
    else if( $("#page-show").val() == "resource")
      change_size_svg('1000','750');
  }
}

function showSearch(isHome)
{
  if (!isNullUser())
      setCurrentURL('/users/'+getUserLogin());
  else
      setCurrentURL("");

  $("#resource-page").html("");
  $("#page-show").val("search");

  function success(data)
  { 

    var varProjectsHtml = '<div class="btn-group btn-group-justified"><div class="btn-group"><button type="button" class="btn btn-default" name="/users/'+getUserLogin()+'" onclick="searchResources(this)">'+ getUserName() +'</button></div></div>';
    for (var i = 0; i < data.resource_list.length; i++) 
    { 
      htmlCode = "";
      for (var j = i; j < data.resource_list.length && j < i + 3; j++) 
      {
        htmlCode += '<div class="btn-group"><button type="button" class="btn btn-default" name="'+data.resource_list[j].href+'" onclick="searchResources(this)">'+ data.resource_list[j].name +'</button></div>';
      }
      varProjectsHtml +='<div class="btn-group btn-group-justified">'+htmlCode+'</div>';
      i = j - 1;
    }
    varProjects = {"is_home_project": true, "list_projects":varProjectsHtml};
    loadTemplate("template-search-menu", "left-menu", false, varProjects);

    $("#link-show-left-menu").attr("rel","false");
    showLeftMenu(true);

    loadTemplate("template-search-content", "resource-page", false, {"is_user" : true, "is_search" : true});

    searchResources(null);
  }
  function error(jqXHR, textStatus, errorThrown) { showError(jqXHR.status, jqXHR.statusText, "get project list !");}
  
  if (!isNullUser() && isHome)
    get(getCurrentURL() + "/projects", success, error);
  else
  { 
    $("#link-show-left-menu").attr("rel","false");
    if (isNullUser())
    {
      showLeftMenu(false);
      loadTemplate("template-search-menu", "left-menu", false, {"is_home_project": false, "list_projects":{}});
    }
    else
    {
      showLeftMenu(true);
      loadTemplate("template-search-menu", "left-menu", false, {"is_home_project": true, "list_projects":{}});
    }

    loadTemplate("template-search-content", "resource-page", false, {"is_user" : true, "is_search" : true});

    searchResources(null);
  }
    
}

function searchResources(element)
{ 
  if (element == null);
  else if ($(element).hasClass("btn-primary"))
  {
    $(element).removeClass("btn-primary");
    $(element).addClass("btn-default");
  } 
  else if ($(element).hasClass("btn-default"))
  {
    $(element).removeClass("btn-default");
    $(element).addClass("btn-primary");
  }
  else if ($(element).attr("rel") == "select-project-ok")
  {
    $("#menu-project-part").children().find("button").removeClass("btn-default");
    $("#menu-project-part").children().find("button").addClass("btn-primary");
  }
  else if ($(element).attr("rel") == "select-project-no")
  {
    $("#menu-project-part").children().find("button").removeClass("btn-primary");
    $("#menu-project-part").children().find("button").addClass("btn-default");

  }

  var projects = "";
  $("#menu-project-part").children().find(".btn-primary").each(function(index){
    if (index != 0)
      projects += ",";
    projects += $(this).attr("name");
  });

  if (projects == "" && $("#page-show").val() == "search" && (isNullUser() || $("#search-button-all").hasClass("btn-primary")))
  {
    projects = "/";
  }
  else if (projects == "" && $("#page-show").val() == "search" && $("#search-button-home").hasClass("btn-primary"))
  {
    projects = "/users/" + getUserLogin();
  }
  else if (projects == "" && $("#page-show").val() != "search")
  {
    projects = getCurrentURL();
  }

  function success(data)
  { 
    varSearchResults["resource_list"] = data;
    function successIsEdit(data)
    { 
      varSearchResults["is_edit"] = data.is_edit;
      showResultSearch(($("#left-menu").css('display') != "none"));
    }
    function errorIsEdit(jqXHR, textStatus, errorThrown) { varSearchResults["is_edit"] = false; showResultSearch(($("#left-menu").css('display') != "none"));}
    if (!isNullUser() && $("#resource-nav-tabs").children(".active").children("a").attr("rel") != "user"){
      get(getCurrentURL() + "/"+$("#resource-nav-tabs").children(".active").children("a").attr("rel")+"s", successIsEdit, errorIsEdit);
    }
    else{
      varSearchResults["is_edit"] = false; 
      showResultSearch(($("#left-menu").css('display') != "none"));
    }
  }
  function error(jqXHR, textStatus, errorThrown) { showError(jqXHR.status, jqXHR.statusText, "search resources !");}
  if ($("#resource-nav-tabs").children(".active").children("a").attr("rel") != "user")
  {
    get("/search?urls="+projects+"&types="+$("#resource-nav-tabs").children(".active").children("a").attr("rel")+"s&value="+$("#search-zone-input").val(), success, error);
  }
  else
  {
    get("/search?urls=/&types=users&value="+$("#search-zone-input").val(), success, error);
  }
}

function showResultSearch(isMenuShow)
{
  var length = (isMenuShow)? 4 : 6;

  var htmlCode = "";

  if (!isNullUser() && varSearchResults.is_edit)
  {
    htmlCode += '<div class="row"><div class="col-md-'+((isMenuShow)? 3 : 2)+'" style="padding:2px;"><a href="#" onclick="newResource(\''+varSearchResults.type+'\')" style=""><div class="'+varSearchResults.color_resource+'" style="margin:5px;height:150px;padding-top:24%; padding-left:30%;color: inherit; border-radius: 6px;"><i class="fa fa-plus-circle fa-5x"></i></div></a></div>';
    var j = 2;
  }
  else
    var j = 1;
  for (var i = 0; i < varSearchResults.resource_list.length; i++) 
  {
    if (j == 1)
      htmlCode += '<div class="row">';
    
    htmlCode +='<div class="col-md-'+((isMenuShow)? 3 : 2)+'" style="padding:2px;">';
    var source = $("#template-search-result").html();
    template = Handlebars.compile(source);
    htmlCode += template(varSearchResults.resource_list[i]);
    htmlCode += '</div>';

    if (j == length)
    {
      htmlCode += '</div>';
      j = 1;
    } 
    else
      j++; 
  }
  if (j < length)
    htmlCode += '</div>';
  $("#resource-list").html(htmlCode);
  $("#resource-list").append('<div id="modal-copy-move-div"></div><input type="hidden" id="search-showing" value="true" />');

  $("[class='class-double-buttons']").bootstrapSwitch();
}

function showResource(element, url)
{
  if ($(element).attr("rel") == "Project")
  {
    showProject(url);
  }
  else if ($(element).attr("rel") == "User")
  {
    showUser(url);
  }
  else if ($(element).attr("rel") == "Model")
  {
    showModel(url);
  }
  else if ($(element).attr("rel") == "Formalism")
  {
    showFormalism(url);
  }
  else if ($(element).attr("rel") == "Service")
  {
    showService(url);
  }
  else if ($(element).attr("rel") == "Execution")
  {
    showExecution(url);
  }
  else if ($(element).attr("rel") == "Scenario")
  {
    showScenario(url);
  }
}

function showProject(url)
{
  setCurrentURL(url);

  function success(data)
  { 
    $("#resource-page").html("");
    $("#left-menu").html("");

    $("#page-show").val("project");

    loadTemplate("template-project-menu", "left-menu", false, {});

    loadTemplate("template-search-content", "resource-page", false, {"is_user" : false, "is_search" : false});
    searchResources(null);

    $("#link-show-left-menu").attr("rel","false");
    showLeftMenu(true);
  }
  function error(jqXHR, textStatus, errorThrown) { showError(jqXHR.status, jqXHR.statusText, "Unauthorized access !");}
  get(getCurrentURL(), success, error);
}

function newProject(isUserShow)
{ 
  showNavTab(null, "Project");

  newResource("Project");
}

function showUser(url)
{ 
  setCurrentURL(url);

  function success(data)
  { 

    $("#resource-page").html("");
    $("#left-menu").html("");

    $("#page-show").val("user");

    loadTemplate("template-user-menu", "left-menu", false, {});

    loadTemplate("template-search-content", "resource-page", false, {"is_user" : true, "is_search" : false});
    searchResources(null);

    $("#link-show-left-menu").attr("rel","false");
    showLeftMenu(true);
  }
  function error(jqXHR, textStatus, errorThrown) { showError(jqXHR.status, jqXHR.statusText, "Unauthorized access !");}
  get(getCurrentURL(), success, error);
}

function newUser()
{
  showLeftMenu(false);
  loadTemplate("template-user-new", "resource-page", false, {});
}

function showBase(url)
{ 
  setCurrentURL(url);

  $("#resource-page").html("");
  $("#left-menu").html("");

  $("#page-show").val("resource");

  loadTemplate("template-resource-menu", "left-menu", false, {});

  loadTemplate("template-resource-content", "resource-page", false, {});

  $("#link-show-left-menu").attr("rel","false");
  showLeftMenu(true);
}

function showModel(url)
{ 
  showBase(url);
}

function showFormalism(url)
{ 
  showBase(url);
}

function showService(url)
{ 
  showBase(url);
}

function showExecution(url)
{ 
  showBase(url);
}

function showScenario(url)
{ 
  showBase(url);
}

function newResource(type)
{
  loadTemplate("template-resource-new", "resource-list", false, {"type" : type});
}

function fsort(isASC)
{
  var array = varSearchResults.resource_list;
  for (var i=0; i < array.length - 1 ; i++) 
  { 
    var tmp1 = array[i];
    for (var j=i+1; j < array.length; j++) 
    { 
      var tmp2 = array[j];
      if ((tmp2.name.toLowerCase() > tmp1.name.toLowerCase() && !isASC) || (tmp2.name.toLowerCase() < tmp1.name.toLowerCase() && isASC))
      {
        array[i] = tmp2;
        array[j] = tmp1;
        tmp1 = tmp2;
      }
    }
  }
  if ($("#left-menu").css('display') == "none")
    showResultSearch(false);
  else
    showResultSearch(true);
  if (isASC)
  {
    $("#search-button-asc").removeClass("color-gris");
    $("#search-button-asc").addClass("color-noir");
    $("#search-button-desc").removeClass("color-noir");
    $("#search-button-desc").addClass("color-gris");
  }
  else
  {
    $("#search-button-asc").removeClass("color-noir");
    $("#search-button-asc").addClass("color-gris");
    $("#search-button-desc").removeClass("color-gris");
    $("#search-button-desc").addClass("color-noir");
  }
}

function copyResource(href)
{
  var params = {"title":"Copy",
                "action":"copy",
                "src" : href};
  var source = $("#template-modal-copy-move").html();
  template = Handlebars.compile(source);
  $("#modal-copy-move-div").html(template(params)); 
} 

function moveResource(href)
{
  var params = {"title":"Move",
                "action":"move",
                "src" : href};
  var source = $("#template-modal-copy-move").html();
  template = Handlebars.compile(source);
  $("#modal-copy-move-div").html(template(params)); 
}

function deleteResource(href, type, is_search)
{
  function success(data)
  { 
    if ($("#page-show").val() == "search" && $("#resource-nav-tabs").children(".active").children("a").attr("rel") == "user")
    {
      logoutClick();
    }
    else if (!is_search)
    {
      if ($("#page-show").val() == "user")
        logoutClick();
      else
        showSearch(true);
    }
    else
    {
      loadTemplate("template-search-content", "resource-page", false, {"is_user" : ($("#page-show").val() == "user" || $("#page-show").val() == "search"), "is_search" : ($("#page-show").val() == "search")});
      showNavTab(null, type);
      searchResources(null);
    }
  }
  function error(jqXHR, textStatus, errorThrown) { showError(jqXHR.status, jqXHR.statusText, "delete resource !");}
  
  if (type != "Project")
    del(href, success, error);
  else
    del("/users/"+getUserLogin()+href, success, error);
}

function fullScreen()
{
  if ($("#body-button-fullscreen").hasClass("screen-close"))
  {
    $("#body-button-fullscreen").removeClass("screen-close");
    $("#body-button-fullscreen").addClass("screen-open");
    $("#body-button-fullscreen").removeClass("glyphicon-resize-full");
    $("#body-button-fullscreen").addClass("glyphicon-resize-small");
    $("#body-button-fullscreen").attr("title", "Small screen");
    $('body').fullscreen();
  }
  else
  {
    $("#body-button-fullscreen").removeClass("screen-open");
    $("#body-button-fullscreen").addClass("screen-close");
    $("#body-button-fullscreen").removeClass("glyphicon-resize-small");
    $("#body-button-fullscreen").addClass("glyphicon-resize-full");
    $("#body-button-fullscreen").attr("title", "Full screen");
    $.fullscreen.exit();
  }
  return false;
}

showLoginLogout();
      
</script>

</body></html>
